{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-Shirt Customizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'task_2/css/style.css' %}">
</head>
<body class="bg-light">

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-7">
                <h2 class="mb-4">Customize Your T-Shirt</h2>
                <div class="product-container shadow-sm p-3 bg-white rounded">
                    <img src="{% static 'task_2/images/tshirt.png' %}" class="img-fluid" alt="T-Shirt">
                    <div id="text-overlay" class="text-overlay">PREVIEW</div>
                </div>
            </div>

            <div class="col-md-5">
                <div class="controls mt-4 mt-md-0">
                    <h3 class="mb-3">Add Text</h3>
                    <div class="mb-3">
                        <label for="customText" class="form-label">Enter Your Text:</label>
                        <input type="text" class="form-control" id="customText" placeholder="Your Text Here" maxlength="20">
                    </div>
                    <button id="saveButton" class="btn btn-primary w-100">Save Design</button>
                    <div id="alert-placeholder" class="mt-3"></div>
                </div>

                <div class="designs mt-5">
                    <h3>My Recent Designs</h3>
                    <ul id="designsList" class="list-group">
                        {% for design in designs %}
                            <li class="list-group-item">{{ design.custom_text }}</li>
                        {% empty %}
                            <li id="no-designs-msg" class="list-group-item">No designs saved yet.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const customTextInput = document.getElementById('customText');
            const textOverlay = document.getElementById('text-overlay');
            const saveButton = document.getElementById('saveButton');
            const designsList = document.getElementById('designsList');
            const alertPlaceholder = document.getElementById('alert-placeholder');

            // Live Preview: Update text on the t-shirt as user types
            customTextInput.addEventListener('keyup', () => {
                textOverlay.textContent = customTextInput.value || 'PREVIEW';
            });

            // Function to show alerts
            const showAlert = (message, type) => {
                alertPlaceholder.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
                setTimeout(() => { alertPlaceholder.innerHTML = ''; }, 3000);
            }

            // Helper function to update the designs list on the page
            const updateDesignsList = (designs) => {
                designsList.innerHTML = ''; 
                if (designs && designs.length > 0) {
                    designs.forEach(design => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.textContent = design.custom_text;
                        designsList.appendChild(li);
                    });
                } else {
                    designsList.innerHTML = '<li class="list-group-item">No designs saved yet.</li>';
                }
            };

            //Save Design Send data to Django backend
            saveButton.addEventListener('click', () => {
                const textToSave = customTextInput.value.trim();

                if (!textToSave) {
                    showAlert('Please enter some text before saving.', 'warning');
                    return;
                }

                // Get CSRF token from cookie
                const csrfToken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

                fetch('save/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken 
                    },
                    body: JSON.stringify({ text: textToSave })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAlert(data.message, 'success');
                        updateDesignsList(data.designs);
                    } else {
                        showAlert(data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('An unexpected error occurred.', 'danger');
                });
            });
        });
    </script>
</body>
</html>