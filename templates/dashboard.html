<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container my-5">
    <h1 class="mb-4">Social Agent Dashboard</h1>
    <hr>
    
    <div class="row mb-4">
        <div class="col-md-4">
            <label for="platformFilter" class="form-label">Filter by Platform:</label>
            <select class="form-select" id="platformFilter" onchange="fetchData()">
                <option value="">All Platforms</option>
            </select>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Post Status Breakdown</h5>
                </div>
                <div class="card-body">
                    <canvas id="postStatsChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-5 mx-auto">
            <div class="card shadow-lg border-success h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">AI Performance Insight</h5>
                </div>
                <div class="card-body">
                    <p id="aiInsightText" class="lead text-dark">Loading AI analysis...</p>
                    <p class="text-muted small mt-3">Insight based on current post metrics.</p>
                </div>
                <div class="card-footer text-muted small" id="totalPostsFooter">Total Posts: 0</div>
            </div>
        </div>
    </div>
</div>

<script>
    const STATS_URL = 'http://127.0.0.1:8000/api/dashboard/stats/';
    const INSIGHT_URL = 'http://127.0.0.1:8000/api/dashboard/insight/';
    let myChart = null; // Variable to hold the Chart.js instance

    // Function to render the Chart.js chart
    function renderChart(stats) {
        const ctx = document.getElementById('postStatsChart').getContext('2d');
        
        // Destroy previous chart instance if it exists
        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(ctx, {
            type: 'pie', // Pie chart for breakdown visualization
            data: {
                labels: ['Published', 'Scheduled', 'Failed'],
                datasets: [{
                    data: [stats.posts_published, stats.posts_scheduled, stats.posts_failed],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)', // Green for Published
                        'rgba(0, 123, 255, 0.8)', // Blue for Scheduled
                        'rgba(220, 53, 69, 0.8)' // Red for Failed
                    ],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Post Status Distribution'
                    }
                }
            }
        });
    }
    
    // Function to populate the platform filter dropdown (Stretch Goal)
    function populatePlatformFilter(options) {
        const select = document.getElementById('platformFilter');
        // Clear previous options (except 'All Platforms')
        select.innerHTML = '<option value="">All Platforms</option>'; 
        
        options.forEach(platform => {
            const option = document.createElement('option');
            option.value = platform;
            option.textContent = platform;
            select.appendChild(option);
        });
    }

    async function fetchData() {
        const platform = document.getElementById('platformFilter').value;
        
        const statsUrlWithFilter = platform ? `${STATS_URL}?platform=${platform}` : STATS_URL;
        const insightUrlWithFilter = platform ? `${INSIGHT_URL}?platform=${platform}` : INSIGHT_URL;
        
        try {
            // Fetch Stats Data
            const statsResponse = await fetch(statsUrlWithFilter);
            const statsData = await statsResponse.json();
            
            // Render Chart
            renderChart(statsData);
            
            // Update Footer
            document.getElementById('totalPostsFooter').textContent = `Total Posts: ${statsData.total_posts}`;
            
            // Populate filter options (this only runs once)
            if (statsData.platform_options) {
                populatePlatformFilter(statsData.platform_options);
            }

            // Fetch AI Insight Data based on the selected platform
            const insightResponse = await fetch(insightUrlWithFilter);
            const insightData = await insightResponse.json();
            document.getElementById('aiInsightText').textContent = insightData.insight;

        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            document.getElementById('aiInsightText').textContent = 'Error loading data. Check your Django backend and CORS settings!';
        }
    }
    window.onload = fetchData;
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
